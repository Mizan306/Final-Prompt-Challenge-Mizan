<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Task Manager + AI Assistant</title>
  <style>
    /* ================= THEMES ================= */
    :root[data-theme="light"]{
      --bg:#f9fafb;
      --panel:#ffffff;
      --ink:#111827;
      --muted:#6b7280;
      --cyan:#2563eb;
      --green:#16a34a;
      --red:#dc2626;
      --pink:#db2777;
      --shadow:rgba(0,0,0,.08);
    }
    :root[data-theme="dark"]{
      --bg:#0a0f1a;
      --panel:#161b24;
      --ink:#f1f5ff;
      --muted:#9ca3af;
      --cyan:#22d3ee;
      --green:#39ff14;
      --red:#f87171;
      --pink:#ff3cac;
      --shadow:rgba(0,0,0,.6);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      color:var(--ink);
      font:15px/1.5 system-ui,Segoe UI,Roboto;
      min-height:100vh;
      padding:24px;
      display:grid;
      place-items:center;
      transition:background .3s,color .3s;
    }
    .app{
      width:min(1100px,96vw);
      background:var(--panel);
      border-radius:12px;
      padding:22px;
      box-shadow:0 4px 16px var(--shadow);
      transition:background .3s,box-shadow .3s;
    }
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    h1{margin:0;font-size:24px;color:var(--cyan);letter-spacing:.5px}
    .toolbar{display:flex;gap:8px;align-items:center}
    .mode{
      font-size:12px;color:var(--muted);
      padding:6px 12px;
      border:1px solid #e5e7eb;
      border-radius:999px;
      background:rgba(0,0,0,.05);
    }
    .btn{
      padding:10px 16px;
      border:0;
      border-radius:8px;
      cursor:pointer;
      color:white;
      transition:all .2s;
    }
    .btn:hover{opacity:0.9}
    .btn-refresh{background:var(--cyan)}
    .btn-toggle{background:var(--pink)}
    .grid{display:grid;grid-template-columns:1fr 420px;gap:18px}
    .panel{
      background:var(--panel);
      border:1px solid rgba(0,0,0,.1);
      border-radius:12px;
      padding:16px;
      transition:background .3s;
    }
    .title{
      font-weight:700;
      margin:0 0 12px 0;
      font-size:20px;
      color:var(--pink);
    }
    .filters{display:flex;gap:10px;margin-bottom:10px}
    .search{flex:1;display:flex;gap:8px}
    input,select{
      background:var(--bg);
      border:1px solid #d1d5db;
      color:var(--ink);
      border-radius:8px;
      padding:10px 12px;
      outline:0;
      transition:all .2s;
    }
    input:focus,select:focus{border-color:var(--cyan);box-shadow:0 0 0 3px rgba(37,99,235,.2)}
    .list{display:grid;gap:10px;max-height:420px;overflow:auto;margin-top:10px}
    .card{
      background:var(--bg);
      border:1px solid #e5e7eb;
      border-radius:10px;
      padding:12px;
      display:grid;
      grid-template-columns:auto 1fr auto auto;
      gap:10px;
      align-items:center;
      transition:background .3s,box-shadow .2s;
    }
    .card:hover{background:rgba(0,0,0,.05)}
    .desc{font-weight:500}
    .desc.done{text-decoration:line-through;color:var(--muted)}
    .pill{
      border-radius:8px;
      padding:6px 10px;
      border:0;
      cursor:pointer;
      font-size:14px;
      transition:all .2s;
    }
    .pill-green{background:var(--green);color:white}
    .pill-red{background:var(--red);color:white}
    .addrow{display:grid;grid-template-columns:1fr auto;gap:10px;margin-top:12px}
    .btn-add{background:var(--cyan)}
    /* Chat */
    .chatlog{max-height:460px;overflow:auto;display:grid;gap:8px}
    .bubble{
      border-radius:10px;
      padding:10px 12px;
      white-space:pre-wrap;
      border:1px solid #e5e7eb;
      background:var(--bg);
    }
    .you{color:var(--cyan);font-weight:600}
    .ai{color:var(--green);font-weight:600}
    .sendrow{display:grid;grid-template-columns:1fr auto;gap:10px;margin-top:10px}
    .btn-send{background:var(--green)}
  </style>
</head>
<body>
  <main class="app">
    <header>
      <div><h1>Task Manager</h1></div>
      <div class="toolbar">
        <span id="modeBadge" class="mode">mode: …</span>
        <button id="refreshBtn" class="btn btn-refresh">↻ Refresh</button>
        <button id="toggleBtn" class="btn btn-toggle">🌙 Dark Mode</button>
      </div>
    </header>

    <div class="grid">
      <!-- Left: Tasks -->
      <section class="panel">
        <h2 class="title">Task List</h2>
        <div class="filters">
          <div class="search" style="flex:1">
            <input id="searchInput" type="text" placeholder="Search tasks..." />
          </div>
          <select id="filterSelect" title="Filter">
            <option value="all">All</option>
            <option value="active">Active</option>
            <option value="completed">Completed</option>
          </select>
          <select id="sortSelect" title="Sort">
            <option value="newest">Newest</option>
            <option value="oldest">Oldest</option>
          </select>
        </div>
        <div id="taskList" class="list" aria-live="polite"></div>
        <div class="addrow">
          <input id="taskInput" type="text" placeholder="New task..." />
          <button id="addBtn" class="btn btn-add">Add Task</button>
        </div>
      </section>

      <!-- Right: AI Assistant -->
      <section class="panel">
        <h2 class="title">AI Assistant</h2>
        <div id="chatLog" class="chatlog"></div>
        <div class="sendrow">
          <input id="chatInput" type="text" placeholder="Talk to AI..." />
          <button id="sendBtn" class="btn btn-send">Send</button>
        </div>
      </section>
    </div>
  </main>

  <script>
    const $ = (s)=>document.querySelector(s);

    // Theme toggle logic
    function setTheme(theme){
      document.documentElement.setAttribute("data-theme", theme);
      localStorage.setItem("theme", theme);
      $("#toggleBtn").textContent = theme==="light" ? "🌙 Dark Mode" : "☀️ Light Mode";
    }
    $("#toggleBtn").addEventListener("click",()=>{
      const current=document.documentElement.getAttribute("data-theme");
      setTheme(current==="light"?"dark":"light");
    });
    // Load stored preference
    const saved=localStorage.getItem("theme")||"light";
    setTheme(saved);

    // API
    const api = {
      async list(){ const r=await fetch('/api/tasks'); if(!r.ok) throw new Error('Load failed'); return r.json(); },
      async add(d){ const r=await fetch('/api/tasks',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({description:d})}); if(!r.ok) throw new Error('Add failed'); return r.json(); },
      async complete(id){ const r=await fetch(`/api/tasks/${id}/complete`,{method:'PATCH'}); if(!r.ok) throw new Error('Complete failed'); return r.json(); },
      async remove(id){ const r=await fetch(`/api/tasks/${id}`,{method:'DELETE'}); if(!r.ok && r.status!==204) throw new Error('Delete failed'); return true; },
      async chat(message, execute=true){ const r=await fetch('/api/ai',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message,execute})}); const data=await r.json(); if(!r.ok) throw new Error(data.error||'Assistant error'); return data; },
      async mode(){ const r=await fetch('/api/mode',{cache:'no-store'}); return r.json(); }
    };

    let tasks = [];
    const state = { search:'', filter:'all', sort:'newest' };

    function applyFilters(items){
      let out = items.slice();
      if(state.search){
        const q=state.search.toLowerCase();
        out = out.filter(t=>t.description.toLowerCase().includes(q));
      }
      if(state.filter==='active') out = out.filter(t=>!t.completed);
      if(state.filter==='completed') out = out.filter(t=>t.completed);
      out.sort((a,b)=> state.sort==='oldest' ? a.created_at - b.created_at : b.created_at - a.created_at);
      return out;
    }

    function render(){
      const list = $('#taskList'); list.innerHTML='';
      const frag=document.createDocumentFragment();
      for(const t of applyFilters(tasks)){
        const card=document.createElement('div'); card.className='card';
        const desc=document.createElement('div'); desc.className='desc'+(t.completed?' done':''); desc.textContent=t.description;
        const completeBtn=document.createElement('button'); completeBtn.className='pill pill-green'; completeBtn.textContent='✓';
        completeBtn.title='Complete';
        completeBtn.disabled=t.completed;
        completeBtn.addEventListener('click', async ()=>{ if(!t.completed){ await api.complete(t.id); await load(); }});
        const delBtn=document.createElement('button'); delBtn.className='pill pill-red'; delBtn.textContent='🗑'; delBtn.title='Delete';
        delBtn.addEventListener('click', async ()=>{ await api.remove(t.id); await load(); });
        const dot=document.createElement('div'); dot.style.width='10px'; dot.style.height='10px';
        dot.style.borderRadius='50%'; dot.style.background=t.completed?'var(--green)':'#9ca3af';
        card.appendChild(dot); card.appendChild(desc); card.appendChild(completeBtn); card.appendChild(delBtn);
        frag.appendChild(card);
      }
      list.appendChild(frag);
    }

    async function load(){ tasks = await api.list(); render(); }

    function addBubble(text, who='you'){
      const n=document.createElement('div'); n.className='bubble '+(who==='you'?'you':'ai'); n.textContent=(who==='you'?'You: ':'AI: ')+text;
      $('#chatLog').appendChild(n); $('#chatLog').scrollTop = $('#chatLog').scrollHeight;
    }

    async function sendChat(){
      const input=$('#chatInput'); const msg=input.value.trim(); if(!msg) return;
      addBubble(msg,'you'); input.value='';
      try{
        const data=await api.chat(msg,true);
        if(data.reply) addBubble(data.reply,'ai');
        if(data.executed && data.decision){
          addBubble(`executed: ${data.decision.function}`,'ai');
        }
        await load(); await setModeBadge();
      }catch(e){ addBubble(`error: ${e.message}`,'ai'); }
    }

    async function addFromInput(){
      const input=$('#taskInput'); const text=input.value.trim(); if(!text) return;
      await api.add(text); input.value=''; await load();
    }

    async function setModeBadge(){
      try{ const info=await api.mode(); $('#modeBadge').textContent = info.model?`mode: ${info.mode} (${info.model})`:`mode: ${info.mode}`; }
      catch{ $('#modeBadge').textContent='mode: …'; }
    }

    $('#addBtn').addEventListener('click', addFromInput);
    $('#taskInput').addEventListener('keydown', e=>{ if(e.key==='Enter') addFromInput(); });
    $('#sendBtn').addEventListener('click', sendChat);
    $('#chatInput').addEventListener('keydown', e=>{ if(e.key==='Enter') sendChat(); });
    $('#refreshBtn').addEventListener('click', ()=>{ load(); setModeBadge(); });

    $('#searchInput').addEventListener('input', e=>{ state.search = e.target.value; render(); });
    $('#filterSelect').addEventListener('change', e=>{ state.filter = e.target.value; render(); });
    $('#sortSelect').addEventListener('change', e=>{ state.sort = e.target.value; render(); });

    setModeBadge(); load();
  </script>
</body>
</html>
